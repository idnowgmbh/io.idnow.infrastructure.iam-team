# GitLab CI/CD Pipeline for TEAM Application Deployment to AWS Amplify
# This pipeline builds the React app and deploys it to Amplify using manual deployment

stages:
  - build
  - deploy-sbx
  - deploy-prd

variables:
  NODE_VERSION: "22.17"
  AWS_DEFAULT_REGION: "eu-central-1"

# Build stage - builds the React application
build:
  stage: build
  image: node:${NODE_VERSION}
  before_script:
    - npm ci
  script:
    - npm run build
  artifacts:
    paths:
      - build/
    expire_in: 1 hour
  only:
    - main
    - develop

# Deploy to Sandbox environment
deploy-sandbox:
  stage: deploy-sbx
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  before_script:
    # Install Node.js and Amplify CLI
    - yum update -y
    - yum install -y nodejs npm
    - npm install -g @aws-amplify/cli@14.0.0
    # Configure AWS credentials from GitLab CI/CD variables
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID_SBX
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY_SBX
    - aws configure set default.region $AWS_DEFAULT_REGION
  script:
    # Get Amplify App ID from Terraform outputs or set manually
    - export AMPLIFY_APP_ID=$AMPLIFY_APP_ID_SBX
    # Deploy to Amplify
    - |
      if [ -z "$AMPLIFY_APP_ID" ]; then
        echo "Error: AMPLIFY_APP_ID_SBX variable not set"
        exit 1
      fi
    - echo "Deploying to Amplify App ID: $AMPLIFY_APP_ID"
    - aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name main
    - |
      UPLOAD_URL=$(aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name main --query 'fileUploadUrls.RootUrl' --output text)
      echo "Upload URL: $UPLOAD_URL"
    # Create deployment package
    - cd build && zip -r ../deployment.zip . && cd ..
    # Upload to Amplify
    - |
      UPLOAD_URL=$(aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name main --query 'fileUploadUrls.RootUrl' --output text)
      JOB_ID=$(aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name main --query 'jobId' --output text)
      curl -X PUT "$UPLOAD_URL" --upload-file deployment.zip
      aws amplify start-deployment --app-id $AMPLIFY_APP_ID --branch-name main --job-id $JOB_ID
  dependencies:
    - build
  only:
    - main
  environment:
    name: sandbox
    url: https://$AMPLIFY_APP_ID_SBX.amplifyapp.com

# Deploy to Production environment
deploy-production:
  stage: deploy-prd
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  before_script:
    # Install Node.js and Amplify CLI
    - yum update -y
    - yum install -y nodejs npm
    - npm install -g @aws-amplify/cli@14.0.0
    # Configure AWS credentials from GitLab CI/CD variables
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID_PRD
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY_PRD
    - aws configure set default.region $AWS_DEFAULT_REGION
  script:
    # Get Amplify App ID from Terraform outputs or set manually
    - export AMPLIFY_APP_ID=$AMPLIFY_APP_ID_PRD
    # Deploy to Amplify
    - |
      if [ -z "$AMPLIFY_APP_ID" ]; then
        echo "Error: AMPLIFY_APP_ID_PRD variable not set"
        exit 1
      fi
    - echo "Deploying to Amplify App ID: $AMPLIFY_APP_ID"
    # Create deployment package
    - cd build && zip -r ../deployment.zip . && cd ..
    # Upload to Amplify
    - |
      UPLOAD_URL=$(aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name main --query 'fileUploadUrls.RootUrl' --output text)
      JOB_ID=$(aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name main --query 'jobId' --output text)
      curl -X PUT "$UPLOAD_URL" --upload-file deployment.zip
      aws amplify start-deployment --app-id $AMPLIFY_APP_ID --branch-name main --job-id $JOB_ID
  dependencies:
    - build
  only:
    - main
  when: manual
  environment:
    name: production
    url: https://$AMPLIFY_APP_ID_PRD.amplifyapp.com

# Alternative simplified deployment using AWS CLI only
.deploy_template: &deploy_template
  image: 
    name: amazon/aws-cli:latest
    entrypoint: [""]
  before_script:
    - yum update -y
    - yum install -y zip
  script:
    # Create deployment package
    - cd build && zip -r ../deployment.zip . && cd ..
    # Deploy using AWS CLI
    - |
      DEPLOYMENT=$(aws amplify create-deployment --app-id $AMPLIFY_APP_ID --branch-name main)
      UPLOAD_URL=$(echo $DEPLOYMENT | jq -r '.fileUploadUrls.RootUrl')
      JOB_ID=$(echo $DEPLOYMENT | jq -r '.jobId')
      
      echo "Uploading to: $UPLOAD_URL"
      curl -X PUT "$UPLOAD_URL" --upload-file deployment.zip
      
      echo "Starting deployment with Job ID: $JOB_ID"
      aws amplify start-deployment --app-id $AMPLIFY_APP_ID --branch-name main --job-id $JOB_ID
      
      echo "Deployment started. Check AWS Amplify console for progress."
